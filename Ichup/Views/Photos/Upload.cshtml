@{
    ViewBag.Title = "Upload";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- ============================  Categories Start ============================ -->

    <section class="picture-categories">

      <div class="container">
        <div class="row">
          <div class="span12">
            <div class="single-image-container">
              <div class="row-fluid">
                <div class="span1">

                  <h4 class="title">Upload Ảnh</h4>                  
                </div> <!-- end span1 -->

                <div class="span11">
                    <ul class="nav nav-tabs">
                      <li class="active"><a href="#"><i class="icon-picture icon-large"></i></a></li>
                      <li><a href="#"><i class="icon-facetime-video icon-large"></i></a></li>
                      <li><a href="#"><i class="icon-music icon-large"></i></a></li>
                    </ul>
                </div> <!-- end span8 -->
               
              </div><!--  end row-fluid -->
            </div> <!-- end single-image-container -->
          </div> <!-- end span12 -->

        </div> <!-- end row -->

        <div class="single-image-title v2">
          <div class="row">
            <div class="span12">
              
            </div> <!--end span12-->
          </div> <!-- end row -->
        </div> <!-- end single-image-title -->
      </div> <!-- end container -->

    </section> <!-- end picture-categories -->



    <!-- ============================  Categories End ============================ -->

    <!-- ============================  Image Decription Starts ============================ -->


    <section class="image-decription-container">
      <div class="container">
        <div class="row" style="text-align:center;">
          <p style="text-align:justify;"><b>Chú ý: </b><br />
                      -Có thể upload nhiều ảnh một lúc<br />
                      -Mỗi từ khóa ấn phím enter để nhập tiếp từ khóa tiếp theo cho mỗi ảnh.

                  </p>  
          <input type="file" name="imageFile" id="imageFile" multiple="multiple"  runat="server" onchange="uploadProcess();">
          <div style="display:block;float:left;position:relative;width:100%;" id="divPR1">

          </div>
          <input type="button" class="class-form" value="Save" onclick="saveAll();">  
        </div> <!-- end row -->
      </div> <!-- end container -->
    </section> <!-- end image-description-container -->

  <!-- ============================  Image Decription Ends ============================ -->
<script>
    var totalindex = -1;
    var fileInput = document.getElementById('imageFile');
    var totalItemImage = -1;
    function uploadProcess() {
       
        for (i = totalItemImage+1; i < fileInput.files.length + totalItemImage+1; i++) {
            var pr = "<div style=\"background-color:#ffffff;width:200px;height:auto;display:block;possition:relative;float:left;margin-right:5px;margin-bottom:1px;\">";
            pr += "<div id=img_" + i + " class=\"progressbar\" style=\"background-color:#fff;margin-top:5px;width:200px;height:126px;display:block;possition:relative;float:left;\">";
            pr += "<div id=\"progresslabel" + i + "\" class=\"progressbarlabel\" style=\"background-color:green;width:1px;height:9px;display:block;possition:relative;float:left;\">uploading...</div>";
            pr += "</div>";
            pr += "<div style=\"background-color:#ffffff;width:200px;height:auto;display:block;possition:relative;float:left;margin-top:2px;\">Từ khóa(cách nhau dấu ,)<textarea id=keyword_" + i + " style=\"width:100%;\" placeholder=\"từ khóa ảnh\" class=\"example\" rows=\"1\"></textarea><input type=hidden id=id_"+i+">Giá: <input type=text id=price_"+i+" placeholder=\"Nhập giá\" onblur=\"checkPrice(this);\"></div>";
            pr += "</div>";
            $("#divPR1").append(pr);
            //$('#keyword_'+i).textext({ plugins: 'tags' });
        }
        totalindex = -1;
        newupload(fileInput.files[0].name, fileInput.files[0]);
        return false;
    }
    function newupload(filename, fileobj) {
        totalindex++;
        totalItemImage++;
        if (totalindex >= fileInput.files.length) return;
        //alert(totalindex);
        filename = fileInput.files[totalindex].name;
        fileobj = fileInput.files[totalindex];
        //alert(filename + "," + fileobj);
        var formdata = new FormData();
        formdata.append(filename, fileobj);  
        //formdata.append("a", "10");
        var xhr = new XMLHttpRequest();       
        xhr.upload.addEventListener("progress", function (evt) {
            if (evt.lengthComputable) {
                var progress = Math.round(evt.loaded * 100 / evt.total);
                progress = progress * 200 / 100;
                $("#progresslabel" + totalItemImage).css("width", progress);//.progressbar("value", progress);//.html(progress);//
                //$("#progresslabel" + index).html(progress);
                //alert("ok"+totalindex);
            }
        }, false);
        //alert("111");
        xhr.open('POST', '/Photos/UploadImageProcess');//UploadImageProcess
        xhr.send(formdata);//formdata
        //alert("222");
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                //alert(xhr.responseText);
                var str = xhr.responseText.split(":");
                $('#img_' + totalItemImage).html("<img src=\"" + str[0] + "\" width=200 height=126 id=\"image_" + totalItemImage + "\">");
                $('#id_' + totalItemImage).val(str[1]);
                newupload(filename, fileobj);
            }
            
        }
        

    }
    function saveAll() {
        var formdata = new FormData(); //FormData object
        if (totalItemImage < 0) {
            alert("Upload ít nhất một ảnh!");
            return;
        }
        for (var i = 0; i < totalItemImage; i++) {
            if (document.getElementById("keyword_" + i) && document.getElementById("keyword_" + i).value == "") {
                alert("Nhập từ khóa cho ảnh này!");
                document.getElementById("keyword_" + i).focus();
                return;
            }
            if (document.getElementById("price_" + i) && document.getElementById("price_" + i).value == "") {
                alert("Nhập giá cho ảnh này!");
                document.getElementById("price_" + i).focus();
                return;
            }
        }
        
        
        formdata.append("totalitem", totalItemImage);
        for (var i = 0; i < totalItemImage; i++) {
            if (document.getElementById("keyword_"+i)) {
                formdata.append("keyword_" + i, document.getElementById("keyword_" + i).value);
                formdata.append("price_" + i, document.getElementById("price_" + i).value);
                formdata.append("id_" + i, document.getElementById("id_" + i).value);
            }
        }

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/Photos/Update');
        xhr.send(formdata);
        var content = "";
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                if (xhr.responseText == "1") {
                    alert("Cập nhật thành công");
                    window.location.href = "/Home";
                } else {
                    alert("Chương trình đang cập nhật, xin quay lại sau!");
                }
            }
        }
    }
    function checkPrice(obj) {
        if (isNaN(obj.value)) obj.value = parseInt(obj.value);
    }
</script>