@{
    ViewBag.Title = "Upload";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<section class="search-index-08">
        <div class="container">
            <div class="col-md-12">
                <ul class="post-menu-cat">
                    <li class="active"><a class="col-xs-12 col-sm-4 col-md-2" href="/Photos/Upload">Upload ảnh/Video</a></li>
                    <li><a class="col-xs-12 col-sm-4 col-md-2" href="/Photos/User">Gán từ khóa</a></li>
                    <li><a class="col-xs-12 col-sm-4 col-md-2" href="#">Quản lý ảnh/Video</a></li>
                    <li><a class="col-xs-12 col-sm-4 col-md-2" href="#">Lịch sử ảnh đã mua</a></li>
                    <li><a class="col-xs-12 col-sm-4 col-md-2" href="#">Thông tin thanh toán</a></li>
                    <li><a class="col-xs-12 col-sm-4 col-md-2" href="#">Quản lý tài khoản</a></li>

                </ul>
                <div class="clearfix"></div>
            </div>
        </div>
    </section>



    <section class="section-02">
        <div class="container">
            <div class="headline">
                <h1>
                    Upload ảnh của bạn
                </h1>
                <img id="loadingimg" src="/Images/loading.gif" style="display:none;width:50px;height:50px;text-align:center;" />
            </div>
            <div class="bg-11">
                <div class="col-md-12 col-center">
                    <div class="col-md-5 col-center">
                        <div > Chọn file ảnh để upload(có thể chọn nhiều ảnh cùng lúc)<input type="file" name="imageFile" id="imageFile" multiple="multiple"  runat="server" >
                        <div  id="notice"></div>
                    </div>
                    <div class="gallery-index-08">

                        <div id="gallery-respon" class="col-md-12">

                            <div class="clearfix"></div>

                            <div class="list-gallery-index-08 row" id="divPR1">

                                
                            </div>

                            <div class="clearfix"></div>
                            
                        </div>

                        <div class="clearfix"></div>
                    </div>
                   
                </div>
            </div>
            <div class="footer-11">
                <div class="col-md-3 col-md-offset-3">
                    <div class="checkbox">
                        <input type="checkbox" name="checkboxG6" id="checkboxG6" class="css-checkbox" />Tôi đã đọc và đồng ý với <a href="/Home/Rule"> Bản quyền và điều khoản sử dụng</a> của website bananhso.com và đồng ý đăng ký
                    </div>
                </div>

                <div class="col-md-3 submit-11">
                    <div class="div-submit">
                        <button type="button" class="btn-submit" onclick="uploadProcess();">Thực hiện lệnh</button>
                    </div>
                </div>

                <div class="clearfix"></div>
            </div>
        </div>
    </section>
    
    <section class="section-02">
        <div class="container">
            <div class="col-md-12 col-center">
                
                <div class="row">

                    @*<div class="col-md-4 item-section-02">
                        <div class="images"><i class="fa fa-cloud-upload"></i></div>
                        <div class="title">Lorem ipsum dolor sit ame</div>
                        <div class="content-meta">Lorem ipsum dolor sit amet, consectetur adipiscing elit, <a href="#">Hướng dẫn tại đây</a> </div>
                    </div>
                    <div class="col-md-4 item-section-02 border-lr-1">
                        <div class="images"><i class="fa fa-image"></i></div>
                        <div class="title">Lorem ipsum dolor sit ame</div>
                        <div class="content-meta">Lorem ipsum dolor sit amet, consectetur adipiscing elit, <a href="#">Hướng dẫn tại đây</a> </div>
                    </div>
                    <div class="col-md-4 item-section-02">
                        <div class="images"><i class="fa fa-comments"></i></div>
                        <div class="title">Lorem ipsum dolor sit ame</div>
                        <div class="content-meta">
                            <div class="hotline"><i class="fa fa-phone-square"></i> 0900 000 000</div>

                            <div class="face-book"><i class="fa fa-facebook-square"></i> tentrangwweb</div>

                        </div>
                    </div>*@

                </div>
            </div>
        </div>
    </section>
<!-- ============================  Categories Start ============================ -->

    @*<section class="picture-categories">

      <div class="container">
        <div class="row">
          <div class="span12">
            <div class="single-image-container">
              <div class="row-fluid">
                <div class="span1">

                  <h4 class="title">Upload Ảnh</h4>                  
                </div> <!-- end span1 -->

                <div class="span11">
                    <ul class="nav nav-tabs">
                      <li class="active"><a href="#"><i class="icon-picture icon-large"></i></a></li>
                      <li><a href="#"><i class="icon-facetime-video icon-large"></i></a></li>
                      <li><a href="#"><i class="icon-music icon-large"></i></a></li>
                    </ul>
                </div> <!-- end span8 -->
               
              </div><!--  end row-fluid -->
            </div> <!-- end single-image-container -->
          </div> <!-- end span12 -->

        </div> <!-- end row -->

        <div class="single-image-title v2">
          <div class="row">
            <div class="span12">
              
            </div> <!--end span12-->
          </div> <!-- end row -->
        </div> <!-- end single-image-title -->
      </div> <!-- end container -->

    </section> <!-- end picture-categories -->



    <!-- ============================  Categories End ============================ -->

    <!-- ============================  Image Decription Starts ============================ -->


    <section class="image-decription-container">
      <div class="container">
        <div class="row" style="text-align:center;">
          <p style="text-align:justify;"><b>CHÚ Ý QUAN TRỌNG: </b><br />
                      - Có thể upload nhiều ảnh một lúc<br />
                      - Các từ khóa của mỗi ảnh ngăn cách nhau bởi dấu ,
                  </p>  
          <input type="file" name="imageFile" id="imageFile" multiple="multiple"  runat="server" onchange="uploadProcess();">
          <input type="checkbox" id="autoname" name="autoname"/>  Tự động lấy tên ảnh làm tag từ khóa
          <div style="display:block;float:left;position:relative;width:100%;" id="divPR1">
              
          </div>
          <p style="text-align:justify;">  
          <span id="notice"></span>.&nbsp;  
          <input type="button" class="class-form" value="Save All" onclick="saveAll();" id="saveAll" style="display:none;">  
          </p>
        </div> <!-- end row -->
      </div> <!-- end container -->
    </section> <!-- end image-description-container -->*@

  <!-- ============================  Image Decription Ends ============================ -->
<script>
    var totalindex = -1;
    var fileInput = document.getElementById('imageFile');
    var totalItemImage = -1;
    var autoname = false;
    var member_id =@ViewBag.member_id;
    function uploadProcess() {
        if (document.getElementById("checkboxG6").checked==false){
            alert("Bạn chưa đồng ý với điều khoản của bán ảnh số. Xin click vào đồng ý!");
            return;
        }
        //if (fileInput.files.length>10){
            //alert("Mỗi lần bạn chỉ được upload tối đa 10 ảnh!");
            //return;
        //}
        for (i = totalItemImage+1; i < fileInput.files.length + totalItemImage+1; i++) {
            //var pr = "<div style=\"background-color:#ffffff;width:200px;height:auto;display:block;possition:relative;float:left;margin-right:5px;margin-bottom:1px;\">";
            //pr += "<div id=img_" + i + " class=\"progressbar\" style=\"background-color:#fff;margin-top:5px;width:200px;height:126px;display:block;possition:relative;float:left;\">";
            //pr += "<div id=\"progresslabel" + i + "\" class=\"progressbarlabel\" style=\"background-color:green;width:1px;height:9px;display:block;possition:relative;float:left;\">uploading...</div>";
            //pr += "</div>";
            //pr += "<div style=\"background-color:#ffffff;width:200px;height:auto;display:block;possition:relative;float:left;margin-top:2px;\">Từ khóa<textarea id=keyword_" + i + " placeholder=\"Nhập từ khóa\" style=\"width:100%;\"  class=\"example\" rows=\"1\"></textarea><input type=hidden id=id_" + i + "></div>";//Giá bán<input type=text id=price_" + i + " placeholder=\"Nhập giá\" onblur=\"checkPrice(this);\">
            //pr += "</div>";
            var pr ="";
            pr +="<div class=\"col-xs-12 col-sm-6 col-md-2 gallery-item\" style=\"margin-right:100px;\">";
            pr +="<div class=\"gallery-item-thumb\" style=\"height:86px;width:122px;\" id=img_" + i + "><div id=\"progresslabel" + i + "\" class=\"progressbarlabel\" style=\"background-color:green;width:1px;height:9px;display:block;possition:relative;float:left;\">uploading...</div></div>";
            pr +="<div class=\"text-11\" id=des_" + i + "></div>";
            pr +="</div>";
            $("#divPR1").append(pr);
            
        }
        autoname = false;
        //if (document.getElementById("autoname").checked) autoname = true;
        totalindex = -1;
        $("#saveAll").show();
        newupload(fileInput.files[0].name, fileInput.files[0]);
        return false;
    }
    
    function newupload(filename, fileobj) {
        totalindex++;
        totalItemImage++;
        if (totalindex >= fileInput.files.length) return;
        //alert(totalindex);
        $("#notice").html("Đang upload xin chờ");
        $("#loadingimg").show();
        filename = fileInput.files[totalindex].name;
        fileobj = fileInput.files[totalindex];
        //alert(filename + "," + fileobj);
        var formdata = new FormData();
        formdata.append(filename, fileobj);  
        //formdata.append("a", "10");
        var xhr = new XMLHttpRequest();       
        xhr.upload.addEventListener("progress", function (evt) {
            if (evt.lengthComputable) {
                var progress = Math.round(evt.loaded * 100 / evt.total);
                progress = progress * 100 / 100;
                $("#progresslabel" + totalItemImage).css("width", progress);//.progressbar("value", progress);//.html(progress);//

                $("#progresslabel" + totalItemImage).html(progress+"%");
                //alert("ok"+totalindex);
                
            }
        }, false);
        //alert("111");
        formdata.append("autoname", autoname);
        formdata.append("free", false);
        formdata.append("member_id", member_id);        
        xhr.open('POST', '/Photos/UploadImageProcess');//UploadImageProcess
        xhr.send(formdata);//formdata
        //alert("222");
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                //alert(xhr.responseText);
                var str = xhr.responseText.split(":");
                var indexUploaded = totalItemImage + 1;
                $('#img_' + totalItemImage).html("<a href=\"#\"><img src=\"" + str[0] + "\" style=\"height:86px;width:122px;\" id=\"image_" + totalItemImage + "\"></a>");
                $('#id_' + totalItemImage).val(str[1]);
                $('#des_' + totalItemImage).html(str[2]);
                $("#notice").html("Đã upload xong ảnh " + indexUploaded+", <a href='/Photos/User/'>chuyển sang gán từ khóa cho ảnh</a>");
                newupload(filename, fileobj);
                $("#loadingimg").hide();
            }
        }
        

    }
    function saveAll() {
        var formdata = new FormData(); //FormData object
        if (totalItemImage < 0) {
            alert("Upload ít nhất một ảnh!");
            return;
        }
        for (var i = 0; i < totalItemImage; i++) {
            if (!autoname && document.getElementById("keyword_" + i) && document.getElementById("keyword_" + i).value == "") {
                alert("Nhập từ khóa cho ảnh này!");
                document.getElementById("keyword_" + i).focus();
                return;
            }
            //if (document.getElementById("price_" + i) && document.getElementById("price_" + i).value == "") {
            //    alert("Nhập giá cho ảnh này!");
            //    document.getElementById("price_" + i).focus();
            //    return;
            //}
        }
        
        
        formdata.append("totalitem", totalItemImage);
        for (var i = 0; i < totalItemImage; i++) {
            if (document.getElementById("keyword_"+i)) {
                formdata.append("keyword_" + i, document.getElementById("keyword_" + i).value);
                formdata.append("price_" + i, 1000000);
                formdata.append("id_" + i, document.getElementById("id_" + i).value);
                //alert(document.getElementById("keyword_" + i).value);
            }
        }
        //return;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/Photos/Update');
        xhr.send(formdata);
        var content = "";
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                if (xhr.responseText == "1") {
                    alert("Cập nhật thành công");
                    window.location.href = "/Photos/User/"+member_id;
                } else {
                    alert("Có lỗi, bạn xem lại giá bán hoặc từ khóa chưa phù hợp!");
                }
            }
        }
    }
    
</script>